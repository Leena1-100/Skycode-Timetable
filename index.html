<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스카이코드 학생 시간표</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f4f7f6; margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: center; flex-direction: column; color: #333;
        }
        .container {
            width: 100%; max-width: 1200px; background-color: white; padding: 30px;
            border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 { 
            text-align: center; margin-bottom: 20px; 
        }
        h1 img {
            height: 50px;
        }
        
        #main-input-form {
            display: none;
        }
        #toggle-form-btn {
            position: fixed; bottom: 30px; right: 30px; z-index: 100;
            background-color: #007bff; color: white; border: none; border-radius: 50px;
            padding: 15px 25px; font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease-in-out;
        }
        #toggle-form-btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .input-form {
            border: 1px solid #e0e0e0; padding: 20px; border-radius: 8px;
            background-color: #fcfcfc; margin-bottom: 30px;
        }
        .form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; }
        .subject-entry-row {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 40px;
            gap: 10px; align-items: end; margin-bottom: 10px;
        }
        label { margin-bottom: 6px; font-weight: bold; color: #34495e; font-size: 13px; }
        input[type="text"], input[type="time"], select {
            padding: 9px; border: 1px solid #ddd; border-radius: 5px; font-size: 15px;
        }
        .add-subject-btn, .remove-subject-btn {
            background-color: #6c757d; color: white; border: none; border-radius: 5px;
            cursor: pointer; font-size: 14px; padding: 9px;
        }
        .remove-subject-btn { background-color: #dc3545; }
        #submit-btn {
            background-color: #28a745; color: white; width: 100%; padding: 12px;
            font-size: 16px; font-weight: bold; border: none;
            border-radius: 5px; cursor: pointer; margin-top: 10px;
        }
        .tab-container { display: flex; border-bottom: 2px solid #dee2e6; margin-bottom: 1px;}
        .tab-button {
            padding: 10px 20px; border: none; background-color: transparent;
            cursor: pointer; font-size: 16px; border-radius: 5px 5px 0 0;
            margin-bottom: -2px; border: 2px solid transparent;
        }
        .tab-button.active {
            background-color: white; border-color: #dee2e6 #dee2e6 white;
            font-weight: bold; color: #007bff;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; border: 2px solid #dee2e6; border-top: none; padding: 10px;}
        .schedule-grid { display: grid; border-radius: 8px; overflow-x: auto; }
        .grid-header, .time-cell, .student-col-header, .schedule-cell {
            border: 1px solid #e0e0e0; text-align: center; box-sizing: border-box;
        }
        .grid-header, .time-cell { grid-column: 1; }
        .student-col-header { 
            background-color: #ecf0f1; font-weight: bold; padding: 10px; min-width: 150px;
            cursor: pointer; position: relative; z-index: 1;
        }
        .time-cell { font-weight: bold; font-size: 14px; padding: 5px 0;}
        .schedule-cell { position: relative; min-height: 40px; }
        .sticky-col {
            position: -webkit-sticky; position: sticky; left: 0; z-index: 2; 
            background-color: #f8f8f8;
        }
        .sticky-col.grid-header { background-color: #ecf0f1; }
        .subject-block {
            position: absolute; top: 0; left: 2px; right: 2px; bottom: 0;
            font-size: 12px; color: #333; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; cursor: pointer; padding: 4px;
        }
        .subject-block b { font-size: 14px; margin-bottom: 2px; }
        .subject-block .memo-text { font-size: 11px; opacity: 0.9; line-height: 1.2; }
        .is-first-block { border-top-left-radius: 6px; border-top-right-radius: 6px; }
        .is-last-block { border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; }
        .delete-icon {
            position: absolute; top: 4px; right: 4px; color: #c0392b;
            font-size: 14px; cursor: pointer; z-index: 10;
            background: rgba(255,255,255,0.7); border-radius: 50%;
            width: 14px; height: 14px; line-height: 14px; text-align:center; display: none;
        }
        .subject-block.is-first-block:hover .delete-icon { display: block; }
        
        /* 주간 스케줄 팝업(모달) 스타일 */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white; padding: 20px; border-radius: 10px;
            width: 90%; max-width: 900px; max-height: 90vh;
            display: flex; flex-direction: column;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-close-btn { font-size: 28px; font-weight: bold; cursor: pointer; }
        #modal-schedule-container { overflow-y: auto; }
        #modal-schedule-grid {
            display: grid; grid-template-columns: 80px repeat(6, 1fr);
        }
        #modal-schedule-grid .grid-header,
        #modal-schedule-grid .time-cell {
            background-color: #f8f8f8; font-weight: bold; padding: 8px 5px;
            border: 1px solid #e0e0e0;
        }
        #modal-schedule-grid .day-header {
            background-color: #ecf0f1; font-weight: bold; padding: 10px;
            border: 1px solid #e0e0e0;
        }
        #modal-schedule-grid .modal-schedule-cell {
            border: 1px solid #e0e0e0; min-height: 40px; position: relative; 
        }
        
        #print-btn {
            background-color: #17a2b8; color: white; border: none; border-radius: 5px;
            padding: 8px 15px; font-size: 14px; cursor: pointer; margin-left: auto;
        }

        /* --- ✨ 인쇄 관련 스타일 --- */
        @media print {
            body * { visibility: hidden !important; }
            #printable-area, #printable-area * { visibility: visible !important; }
            #printable-area {
                position: absolute; left: 0; top: 0; width: 100%; height: auto;
                font-size: 8pt;
            }
            .modal-content {
                box-shadow: none !important; border: none !important;
                width: 100% !important; max-width: none !important;
                height: auto !important; overflow: visible !important;
                padding: 0 !important; margin: 0 !important;
            }
            #printable-area .modal-header {
                display: flex; justify-content: center; align-items: center;
                margin-bottom: 10mm; padding-top: 5mm;
            }
            #printable-area h2 {
                font-size: 14pt; margin: 0; display: flex; align-items: center;
            }
            #printable-area h2 img { height: 20px; margin-right: 8px; }
            #printable-area #print-btn, #printable-area .modal-close-btn { display: none !important; }

            #print-schedule-container {
                display: flex !important; flex-wrap: wrap !important; justify-content: space-between;
            }
            .printable-section {
                width: 48% !important; height: auto !important;
                page-break-inside: avoid; box-sizing: border-box;
                border: 1px solid #ccc;
            }
            #print-weekday-grid { display: grid; grid-template-columns: 60px repeat(5, 1fr); }
            #print-saturday-grid { display: grid; grid-template-columns: 60px 1fr; }
            
            #printable-area .time-cell, #printable-area .day-header { font-size: 7pt !important; padding: 2px 0 !important; }
            #printable-area .subject-block b { font-size: 8pt !important; margin-bottom: 1px !important; }
            #printable-area .memo-text { font-size: 6pt !important; line-height: 1 !important; white-space: normal; }
            #printable-area .modal-schedule-cell { min-height: 18px !important; }
            
            .subject-수학 { background-color: #b3e0ff !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .subject-영어 { background-color: #ffe0b3 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .subject-과학 { background-color: #b3ffb3 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .subject-국어 { background-color: #ffb3b3 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .subject-사회 { background-color: #e0b3ff !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .subject-기타 { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
        }
        
        .subject-수학 { background-color: #b3e0ff; } .subject-영어 { background-color: #ffe0b3; }
        .subject-과학 { background-color: #b3ffb3; } .subject-국어 { background-color: #ffb3b3; }
        .subject-사회 { background-color: #e0b3ff; } .subject-기타 { background-color: #f0f0f0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <img src="https://raw.githubusercontent.com/Leena1-100/Skycode-Timetable/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202025-08-28%20012041.png" alt="스카이코드 로고">
        </h1>
        <div id="main-input-form" class="input-form"></div>
        <div class="tab-container"></div>
        <div id="월" class="tab-content active"><div class="schedule-grid" id="grid-월"></div></div>
        <div id="화" class="tab-content"><div class="schedule-grid" id="grid-화"></div></div>
        <div id="수" class="tab-content"><div class="schedule-grid" id="grid-수"></div></div>
        <div id="목" class="tab-content"><div class="schedule-grid" id="grid-목"></div></div>
        <div id="금" class="tab-content"><div class="schedule-grid" id="grid-금"></div></div>
        <div id="토" class="tab-content"><div class="schedule-grid" id="grid-토"></div></div>
    </div>
    <template id="subject-entry-template"></template>

    <div id="student-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-student-name"></h2>
                <div>
                    <button id="print-btn" onclick="printSchedule()">인쇄하기</button>
                    <span class="modal-close-btn" onclick="closeModal()" style="margin-left: 15px;">&times;</span>
                </div>
            </div>
            <div id="modal-schedule-container">
                 <div class="schedule-grid" id="modal-schedule-grid"></div>
            </div>

            <div id="printable-area" style="display: none;">
                <div class="modal-header">
                    <h2 id="print-student-name"></h2>
                </div>
                <div id="print-schedule-container">
                    <div class="printable-section">
                        <div class="schedule-grid" id="print-weekday-grid"></div>
                    </div>
                    <div class="printable-section">
                        <div class="schedule-grid" id="print-saturday-grid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="toggle-form-btn" onclick="toggleInputForm()">학생 정보 입력 / 수정</button>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { /* ... 자신의 firebaseConfig ... */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let scheduleData = { '월': {}, '화': {}, '수': {}, '목': {}, '금': {}, '토': {} };
        const weekdayStartHour = 15; const weekdayEndHour = 22;
        const saturdayStartHour = 10; const saturdayEndHour = 18;
        const days = ['월', '화', '수', '목', '금', '토'];
        const weekdayOnlyDays = ['월', '화', '수', '목', '금'];
        const subjectColors = { '수학': 'subject-수학', '영어': 'subject-영어', '과학': 'subject-과학', '국어': 'subject-국어', '사회': 'subject-사회', '기타': 'subject-기타' };
        const timeToMinutes = t => { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; };
        const minutesToTime = m => { const h = Math.floor(m / 60); const min = m % 60; return `${String(h).padStart(2, '0')}:${String(min).padStart(2, '0')}`; };
        
        // --- ✨ 이 아래의 모든 자바스크립트 함수는 이전과 동일하며, openStudentWeekView와 printSchedule만 수정되었습니다. ---
        
        function toggleInputForm() { /* 이전과 동일 */ }
        function openDay(evt, dayName) { /* 이전과 동일 */ }
        function renderAll() { days.forEach(day => renderDay(day)); }
        function renderDay(day) { /* 이전과 동일 */ }
        async function updateSchedule() { /* 이전과 동일 */ }
        async function deleteSchedule(studentName, day, event) { /* 이전과 동일 */ }
        function styleStudentBlocks(studentName, day, isModal = false) { /* 이전과 동일 */ }
        function loadStudentDataToForm(studentName, day) { /* 이전과 동일 */ }
        function validateTimeInput(input) { /* 이전과 동일 */ }
        function addSubjectField() { /* 이전과 동일 */ }
        function closeModal() { document.getElementById('student-modal').style.display = 'none'; }

        // --- ✨ 주간 뷰 생성 함수 수정 ---
        function openStudentWeekView(studentName) {
            document.getElementById('modal-student-name').textContent = `${studentName} 학생 주간 시간표`;
            document.getElementById('print-student-name').innerHTML = `<img src="https://raw.githubusercontent.com/Leena1-100/Skycode-Timetable/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202025-08-28%20012041.png" alt="스카이코드 로고"> ${studentName} 학생 주간 시간표`;
            
            const modalGrid = document.getElementById('modal-schedule-grid');
            modalGrid.innerHTML = '';
            
            const modalStartHour = Math.min(weekdayStartHour, saturdayStartHour);
            const modalEndHour = Math.max(weekdayEndHour, saturdayEndHour);

            let modalGridHTML = `<div class="grid-header sticky-col">시간</div>` + days.map(d => `<div class="day-header">${d}</div>`).join('');
            for (let h = modalStartHour; h < modalEndHour; h++) {
                ['00', '30'].forEach(m => {
                    modalGridHTML += `<div class="time-cell sticky-col">${String(h).padStart(2, '0')}:${m}</div>`;
                    days.forEach(day => {
                        modalGridHTML += `<div class="modal-schedule-cell" id="modal-cell-${day}-${h}-${m}"></div>`;
                    });
                });
            }
            modalGrid.innerHTML = modalGridHTML;

            days.forEach(day => {
                const subjects = scheduleData[day]?.[studentName] || [];
                subjects.forEach(subjectInfo => {
                    const duration = subjectInfo.end - subjectInfo.start;
                    for (let t = subjectInfo.start; t < subjectInfo.end; t += 30) {
                        const h = Math.floor(t / 60); const m = t % 60;
                        const cellM = m < 30 ? '00' : '30';
                        const cell = document.getElementById(`modal-cell-${day}-${h}-${cellM}`);
                        if (cell) {
                            let textContent = '';
                            if (t === subjectInfo.start) {
                                textContent = (duration <= 30) ? `<b>${subjectInfo.subject}</b><span class="memo-text">${subjectInfo.memo || ''}</span>` : `<b>${subjectInfo.subject}</b>`;
                            } else if (t === subjectInfo.start + 30) {
                                textContent = `<span class="memo-text">${subjectInfo.memo || ''}</span>`;
                            }
                            const block = document.createElement('div');
                            block.className = `subject-block ${subjectColors[subjectInfo.subject]}`;
                            block.innerHTML = textContent;
                            block.dataset.student = studentName; block.dataset.day = day;
                            cell.appendChild(block);
                        }
                    }
                    styleStudentBlocks(studentName, day, true);
                });
            });
            document.getElementById('student-modal').style.display = 'flex';
        }
        
        // --- ✨ 인쇄 함수 수정 ---
        function printSchedule() {
            const studentName = document.getElementById('modal-student-name').textContent.replace(' 학생 주간 시간표', '');
            const weekdayGrid = document.getElementById('print-weekday-grid');
            const saturdayGrid = document.getElementById('print-saturday-grid');

            let maxWeekdayEnd = 0;
            weekdayOnlyDays.forEach(day => {
                const subjects = scheduleData[day]?.[studentName] || [];
                subjects.forEach(s => { if (s.end > maxWeekdayEnd) maxWeekdayEnd = s.end; });
            });
            const effectiveWeekdayEndHour = Math.max(weekdayStartHour, Math.ceil(maxWeekdayEnd / 60));

            let maxSaturdayEnd = 0;
            const saturdaySubjects = scheduleData['토']?.[studentName] || [];
            saturdaySubjects.forEach(s => { if (s.end > maxSaturdayEnd) maxSaturdayEnd = s.end; });
            const effectiveSaturdayEndHour = Math.max(saturdayStartHour, Math.ceil(maxSaturdayEnd / 60));

            let weekdayHTML = `<div class="grid-header sticky-col">시간</div>` + weekdayOnlyDays.map(d => `<div class="day-header">${d}</div>`).join('');
            for (let h = weekdayStartHour; h < effectiveWeekdayEndHour; h++) {
                ['00', '30'].forEach(m => {
                    if (h * 60 + parseInt(m) >= maxWeekdayEnd && m !== '00') return;
                    weekdayHTML += `<div class="time-cell sticky-col">${String(h).padStart(2, '0')}:${m}</div>`;
                    weekdayOnlyDays.forEach(day => {
                        let cellContent = '';
                        const subjects = scheduleData[day]?.[studentName] || [];
                        const activeSubject = subjects.find(s => (h * 60 + parseInt(m)) >= s.start && (h * 60 + parseInt(m)) < s.end);
                        if(activeSubject){
                           let textContent = '';
                           if ((h * 60 + parseInt(m)) === activeSubject.start) {
                               textContent = (activeSubject.end - activeSubject.start <= 30) ? `<b>${activeSubject.subject}</b><span class="memo-text">${activeSubject.memo || ''}</span>` : `<b>${activeSubject.subject}</b>`;
                           } else if ((h * 60 + parseInt(m)) === activeSubject.start + 30) {
                               textContent = `<span class="memo-text">${activeSubject.memo || ''}</span>`;
                           }
                           cellContent = `<div class="subject-block ${subjectColors[activeSubject.subject]}">${textContent}</div>`;
                        }
                        weekdayHTML += `<div class="modal-schedule-cell">${cellContent}</div>`;
                    });
                });
            }
            weekdayGrid.innerHTML = weekdayHTML;

            let saturdayHTML = `<div class="grid-header sticky-col">시간</div><div class="day-header">토</div>`;
            for (let h = saturdayStartHour; h < effectiveSaturdayEndHour; h++) {
                ['00', '30'].forEach(m => {
                    if (h * 60 + parseInt(m) >= maxSaturdayEnd && m !== '00') return;
                    saturdayHTML += `<div class="time-cell sticky-col">${String(h).padStart(2, '0')}:${m}</div>`;
                    let cellContent = '';
                    const subjects = scheduleData['토']?.[studentName] || [];
                    const activeSubject = subjects.find(s => (h * 60 + parseInt(m)) >= s.start && (h * 60 + parseInt(m)) < s.end);
                    if(activeSubject){
                       let textContent = '';
                       if ((h * 60 + parseInt(m)) === activeSubject.start) {
                           textContent = (activeSubject.end - activeSubject.start <= 30) ? `<b>${activeSubject.subject}</b><span class="memo-text">${activeSubject.memo || ''}</span>` : `<b>${activeSubject.subject}</b>`;
                       } else if ((h * 60 + parseInt(m)) === activeSubject.start + 30) {
                           textContent = `<span class="memo-text">${activeSubject.memo || ''}</span>`;
                       }
                       cellContent = `<div class="subject-block ${subjectColors[activeSubject.subject]}">${textContent}</div>`;
                    }
                    saturdayHTML += `<div class="modal-schedule-cell">${cellContent}</div>`;
                });
            }
            saturdayGrid.innerHTML = saturdayHTML;
            
            window.print();
        }

        window.onload = () => {
            days.forEach(day => {
                db.collection('schedules').doc(day).onSnapshot((doc) => {
                    scheduleData[day] = doc.exists ? doc.data() : {};
                    renderDay(day);
                });
            });
            const modal = document.getElementById('student-modal');
            modal.onclick = function(event) { if (event.target === modal) { closeModal(); } }
            // 초기 로드 시 월요일 탭 활성화
            openDay(null, '월');
        };
    </script>
</body>
</html>
