<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스카이코드 학생 시간표</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f4f7f6; margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: center; flex-direction: column; color: #333;
        }
        .container {
            width: 100%; max-width: 1200px; background-color: white; padding: 30px;
            border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 { 
            text-align: center; margin-bottom: 20px; 
        }
        h1 img {
            height: 50px;
        }
        
        #main-input-form {
            display: none;
        }
        #toggle-form-btn {
            position: fixed; bottom: 30px; right: 30px; z-index: 100;
            background-color: #007bff; color: white; border: none; border-radius: 50px;
            padding: 15px 25px; font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease-in-out;
        }
        #toggle-form-btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .input-form {
            border: 1px solid #e0e0e0; padding: 20px; border-radius: 8px;
            background-color: #fcfcfc; margin-bottom: 30px;
        }
        .form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; }
        .subject-entry-row {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 40px;
            gap: 10px; align-items: end; margin-bottom: 10px;
        }
        label { margin-bottom: 6px; font-weight: bold; color: #34495e; font-size: 13px; }
        input[type="text"], input[type="time"], select {
            padding: 9px; border: 1px solid #ddd; border-radius: 5px; font-size: 15px;
        }
        .add-subject-btn, .remove-subject-btn {
            background-color: #6c757d; color: white; border: none; border-radius: 5px;
            cursor: pointer; font-size: 14px; padding: 9px;
        }
        .remove-subject-btn { background-color: #dc3545; }
        #submit-btn {
            background-color: #28a745; color: white; width: 100%; padding: 12px;
            font-size: 16px; font-weight: bold; border: none;
            border-radius: 5px; cursor: pointer; margin-top: 10px;
        }
        .tab-container { display: flex; border-bottom: 2px solid #dee2e6; margin-bottom: 1px;}
        .tab-button {
            padding: 10px 20px; border: none; background-color: transparent;
            cursor: pointer; font-size: 16px; border-radius: 5px 5px 0 0;
            margin-bottom: -2px; border: 2px solid transparent;
        }
        .tab-button.active {
            background-color: white; border-color: #dee2e6 #dee2e6 white;
            font-weight: bold; color: #007bff;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; border: 2px solid #dee2e6; border-top: none; padding: 10px;}
        .schedule-grid { display: grid; border-radius: 8px; overflow-x: auto; }
        .grid-header, .time-cell, .student-col-header, .schedule-cell {
            border: 1px solid #e0e0e0; text-align: center; box-sizing: border-box;
        }
        .grid-header, .time-cell { grid-column: 1; }
        .student-col-header { 
            background-color: #ecf0f1; font-weight: bold; padding: 10px; min-width: 150px;
            cursor: pointer; position: relative; z-index: 1;
        }
        .time-cell { font-weight: bold; font-size: 14px; padding: 5px 0;}
        .schedule-cell { position: relative; min-height: 40px; }
        .sticky-col {
            position: -webkit-sticky; position: sticky; left: 0; z-index: 2; 
            background-color: #f8f8f8;
        }
        .sticky-col.grid-header { background-color: #ecf0f1; }
        .subject-block {
            position: absolute; top: 0; left: 2px; right: 2px; bottom: 0;
            font-size: 12px; color: #333; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; cursor: pointer; padding: 4px;
        }
        .subject-block b { font-size: 14px; margin-bottom: 2px; }
        .subject-block .memo-text { font-size: 11px; opacity: 0.9; line-height: 1.2; }
        .is-first-block { border-top-left-radius: 6px; border-top-right-radius: 6px; }
        .is-last-block { border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; }
        .delete-icon {
            position: absolute; top: 4px; right: 4px; color: #c0392b;
            font-size: 14px; cursor: pointer; z-index: 10;
            background: rgba(255,255,255,0.7); border-radius: 50%;
            width: 14px; height: 14px; line-height: 14px; text-align:center; display: none;
        }
        .subject-block.is-first-block:hover .delete-icon { display: block; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white; padding: 20px; border-radius: 10px;
            width: 90%; max-width: 900px; max-height: 90vh;
            display: flex; flex-direction: column;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-close-btn { font-size: 28px; font-weight: bold; cursor: pointer; }
        #modal-schedule-container { overflow-y: auto; }
        #modal-schedule-grid {
            display: grid; grid-template-columns: 80px repeat(6, 1fr); /* 5 -> 6 */
        }
        #modal-schedule-grid .grid-header,
        #modal-schedule-grid .time-cell {
            background-color: #f8f8f8; font-weight: bold; padding: 8px 5px;
            border: 1px solid #e0e0e0;
        }
        #modal-schedule-grid .day-header {
            background-color: #ecf0f1; font-weight: bold; padding: 10px;
            border: 1px solid #e0e0e0;
        }
        #modal-schedule-grid .modal-schedule-cell {
            border: 1px solid #e0e0e0; min-height: 40px;
            position: relative; 
        }
        
        .subject-수학 { background-color: #b3e0ff; } .subject-영어 { background-color: #ffe0b3; }
        .subject-과학 { background-color: #b3ffb3; } .subject-국어 { background-color: #ffb3b3; }
        .subject-사회 { background-color: #e0b3ff; } .subject-기타 { background-color: #f0f0f0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <img src="https://raw.githubusercontent.com/Leena1-100/Skycode-Timetable/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202025-08-28%20012041.png" alt="스카이코드 로고">
        </h1>

        <div id="main-input-form" class="input-form">
            <div class="form-row">
                <div class="input-group"><label for="studentName">학생 이름</label><input type="text" id="studentName"></div>
                <div class="input-group"><label for="studyDay">요일</label><select id="studyDay">
                    <option value="월">월요일</option><option value="화">화요일</option><option value="수">수요일</option>
                    <option value="목">목요일</option><option value="금">금요일</option>
                    <option value="토">토요일</option>
                </select></div>
            </div>
            <div id="subjects-container">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 40px; gap: 10px; margin-bottom: 5px; padding: 0 5px;">
                    <label>과목</label><label>시작 시간</label><label>종료 시간</label><label>교재/메모</label>
                </div>
            </div>
            <button class="add-subject-btn" onclick="addSubjectField()">+ 과목 추가하기</button>
            <button id="submit-btn" onclick="updateSchedule()">시간표에 등록/수정</button>
        </div>
        
        <div class="tab-container">
            <button class="tab-button active" onclick="openDay(event, '월')">월요일</button>
            <button class="tab-button" onclick="openDay(event, '화')">화요일</button>
            <button class="tab-button" onclick="openDay(event, '수')">수요일</button>
            <button class="tab-button" onclick="openDay(event, '목')">목요일</button>
            <button class="tab-button" onclick="openDay(event, '금')">금요일</button>
            <button class="tab-button" onclick="openDay(event, '토')">토요일</button>
        </div>
        
        <div id="월" class="tab-content active"><div class="schedule-grid" id="grid-월"></div></div>
        <div id="화" class="tab-content"><div class="schedule-grid" id="grid-화"></div></div>
        <div id="수" class="tab-content"><div class="schedule-grid" id="grid-수"></div></div>
        <div id="목" class="tab-content"><div class="schedule-grid" id="grid-목"></div></div>
        <div id="금" class="tab-content"><div class="schedule-grid" id="grid-금"></div></div>
        <div id="토" class="tab-content"><div class="schedule-grid" id="grid-토"></div></div>
    </div>
    <template id="subject-entry-template">
        <div class="subject-entry-row">
            <div class="input-group"><select class="subject-select">
                <option value="국어">국어</option><option value="수학">수학</option><option value="영어">영어</option>
                <option value="과학">과학</option><option value="사회">사회</option><option value="기타">기타</option>
            </select></div>
            <div class="input-group"><input type="time" class="start-time" step="600" onchange="validateTimeInput(this)"></div>
            <div class="input-group"><input type="time" class="end-time" step="600" onchange="validateTimeInput(this)"></div>
            <div class="input-group"><input type="text" class="memo" placeholder="예: 그래머 1권"></div>
            <button class="remove-subject-btn" onclick="this.parentElement.remove()">-</button>
        </div>
    </template>

    <div id="student-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-student-name"></h2>
                <span class="modal-close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-schedule-container">
                 <div class="schedule-grid" id="modal-schedule-grid"></div>
            </div>
        </div>
    </div>

    <button id="toggle-form-btn" onclick="toggleInputForm()">학생 정보 입력 / 수정</button>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyABj6I5mmD3WN9cu8B0sIB2ZO0INgwBuuI",
          authDomain: "skycode-timetable.firebaseapp.com",
          projectId: "skycode-timetable",
          storageBucket: "skycode-timetable.appspot.com",
          messagingSenderId: "66485090384",
          appId: "1:66485090384:web:8759a841a04a7f3704b955"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let scheduleData = { '월': {}, '화': {}, '수': {}, '목': {}, '금': {}, '토': {} };
        const startTimeHour = 15; const endTimeHour = 22; const days = ['월', '화', '수', '목', '금', '토'];
        const subjectColors = {
            '수학': 'subject-수학', '영어': 'subject-영어', '과학': 'subject-과학',
            '국어': 'subject-국어', '사회': 'subject-사회', '기타': 'subject-기타',
        };
        const timeToMinutes = t => { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; };
        const minutesToTime = m => {
            const h = Math.floor(m / 60); const min = m % 60;
            return `${String(h).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
        };
        
        function toggleInputForm() {
            const form = document.getElementById('main-input-form');
            const btn = document.getElementById('toggle-form-btn');
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
                btn.textContent = '입력창 닫기';
                document.getElementById('studentName').value = '';
                const subjectsContainer = document.getElementById('subjects-container');
                subjectsContainer.innerHTML = `<div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 40px; gap: 10px; margin-bottom: 5px; padding: 0 5px;">
                                                  <label>과목</label><label>시작 시간</label><label>종료 시간</label><label>교재/메모</label>
                                               </div>`;
                addSubjectField();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                form.style.display = 'none';
                btn.textContent = '학생 정보 입력 / 수정';
            }
        }

        function openDay(evt, dayName) {
            document.querySelectorAll(".tab-content").forEach(c => c.classList.remove('active'));
            document.querySelectorAll(".tab-button").forEach(b => b.classList.remove('active'));
            document.getElementById(dayName).classList.add('active');
            if (evt) evt.currentTarget.classList.add('active');
            else document.querySelector(`.tab-button[onclick*="'${dayName}'"]`).classList.add('active');
        }

        function renderAll() { days.forEach(day => renderDay(day)); }

        function renderDay(day) {
            const grid = document.getElementById(`grid-${day}`);
            const studentsWithStartTime = Object.entries(scheduleData[day]).map(([name, subjects]) => {
                const earliestStart = subjects.length > 0 ? Math.min(...subjects.map(s => s.start)) : Infinity;
                return { name, earliestStart };
            });
            studentsWithStartTime.sort((a, b) => a.earliestStart - b.earliestStart);
            const students = studentsWithStartTime.map(s => s.name);
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `80px repeat(${students.length}, 1fr)`;
            let gridHTML = `<div class="grid-header sticky-col" style="grid-column: 1; grid-row: 1;">시간</div>`;
            students.forEach((name, i) => {
                gridHTML += `<div class="student-col-header" onclick="openStudentWeekView('${name}')" style="grid-column: ${i+2}; grid-row: 1;">${name}</div>`;
            });
            let row = 2;
            for (let h = startTimeHour; h < endTimeHour; h++) {
                ['00', '30'].forEach(m => {
                    gridHTML += `<div class="time-cell sticky-col" style="grid-row: ${row};">${String(h).padStart(2, '0')}:${m}</div>`;
                    students.forEach((name, i) => {
                        gridHTML += `<div class="schedule-cell" id="cell-${day}-${name}-${h}-${m}" style="grid-column: ${i+2}; grid-row: ${row};"></div>`;
                    });
                    row++;
                });
            }
            grid.innerHTML = gridHTML;
            students.forEach(studentName => {
                const subjects = scheduleData[day][studentName] || [];
                subjects.forEach(subjectInfo => {
                    const duration = subjectInfo.end - subjectInfo.start;
                    for (let t = subjectInfo.start; t < subjectInfo.end; t += 30) {
                        const h = Math.floor(t / 60); const m = t % 60;
                        const cellM = m < 30 ? '00' : '30';
                        const cell = document.getElementById(`cell-${day}-${studentName}-${h}-${cellM}`);
                        if (cell) {
                            const block = document.createElement('div');
                            block.className = `subject-block ${subjectColors[subjectInfo.subject]}`;
                            block.dataset.student = studentName; block.dataset.day = day;
                            block.onclick = () => loadStudentDataToForm(studentName, day);
                            if (t === subjectInfo.start) {
                                block.innerHTML = (duration <= 30) ? `<b>${subjectInfo.subject}</b><span class="memo-text">${subjectInfo.memo || ''}</span>` : `<b>${subjectInfo.subject}</b>`;
                            } else if (t === subjectInfo.start + 30) {
                                block.innerHTML = `<span class="memo-text">${subjectInfo.memo || ''}</span>`;
                            }
                            cell.appendChild(block);
                        }
                    }
                });
                styleStudentBlocks(studentName, day);
            });
        }
        
        async function updateSchedule() {
            const studentName = document.getElementById('studentName').value;
            const studyDay = document.getElementById('studyDay').value;
            if (!studentName) return alert('학생 이름을 입력해주세요.');
            const subjectRows = document.querySelectorAll('#subjects-container .subject-entry-row');
            if (subjectRows.length === 0) {
                if(scheduleData[studyDay]?.[studentName] && confirm(`일정을 삭제하시겠습니까?`)) {
                    await deleteSchedule(studentName, studyDay);
                }
            } else {
                const subjects = [];
                subjectRows.forEach(row => {
                    const subject = row.querySelector('.subject-select').value;
                    const startStr = row.querySelector('.start-time').value;
                    const endStr = row.querySelector('.end-time').value;
                    const memo = row.querySelector('.memo').value;
                    if (startStr && endStr && timeToMinutes(startStr) < timeToMinutes(endStr)) {
                        subjects.push({ subject, start: timeToMinutes(startStr), end: timeToMinutes(endStr), memo });
                    }
                });
                await db.collection('schedules').doc(studyDay).set({ [studentName]: subjects }, { merge: true });
            }
            document.getElementById('main-input-form').style.display = 'none'; 
            document.getElementById('toggle-form-btn').textContent = '학생 정보 입력 / 수정';
        }

        async function deleteSchedule(studentName, day, event) {
            if(event) event.stopPropagation();
            if (confirm(`일정을 삭제하시겠습니까?`)) {
                await db.collection('schedules').doc(day).update({
                    [studentName]: firebase.firestore.FieldValue.delete()
                });
            }
        }
        
        function styleStudentBlocks(studentName, day, isModal = false) {
            const selector = isModal ? `#modal-schedule-grid .subject-block[data-student="${studentName}"][data-day="${day}"]` : `#grid-${day} .subject-block[data-student="${studentName}"]`;
            const blocks = document.querySelectorAll(selector);
            if (blocks.length === 0) return;
            const sorted = Array.from(blocks).sort((a, b) => a.parentElement.id.localeCompare(b.parentElement.id));
            sorted[0].classList.add('is-first-block');
            sorted[sorted.length - 1].classList.add('is-last-block');
            if (!isModal) {
                const deleteIcon = document.createElement('span');
                deleteIcon.className = 'delete-icon';
                deleteIcon.innerHTML = '✖';
                deleteIcon.onclick = (e) => deleteSchedule(studentName, day, e);
                sorted[0].appendChild(deleteIcon);
            }
        }
        
        function loadStudentDataToForm(studentName, day) {
            document.getElementById('main-input-form').style.display = 'block';
            document.getElementById('toggle-form-btn').textContent = '입력창 닫기';
            openDay(null, day);
            document.getElementById('studentName').value = studentName;
            document.getElementById('studyDay').value = day;
            const subjectsContainer = document.getElementById('subjects-container');
            subjectsContainer.innerHTML = `<div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 40px; gap: 10px; margin-bottom: 5px; padding: 0 5px;">
                                              <label>과목</label><label>시작 시간</label><label>종료 시간</label><label>교재/메모</label>
                                           </div>`;
            const subjects = scheduleData[day][studentName] || [];
            if (subjects.length === 0) addSubjectField();
            subjects.forEach(info => {
                const clone = document.getElementById('subject-entry-template').content.cloneNode(true);
                clone.querySelector('.subject-select').value = info.subject;
                clone.querySelector('.start-time').value = minutesToTime(info.start);
                clone.querySelector('.end-time').value = minutesToTime(info.end);
                clone.querySelector('.memo').value = info.memo || '';
                subjectsContainer.appendChild(clone);
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validateTimeInput(input) {
            if (!input.value) return;
            const [h, m] = input.value.split(':').map(Number);
            const roundedM = Math.round(m / 10) * 10;
            input.value = `${String(h).padStart(2, '0')}:${String(roundedM).padStart(2, '0')}`;
        }
        function addSubjectField() {
            const clone = document.getElementById('subject-entry-template').content.cloneNode(true);
            document.getElementById('subjects-container').appendChild(clone);
        }
        
        function openStudentWeekView(studentName) {
            document.getElementById('modal-student-name').textContent = `${studentName} 학생 주간 시간표`;
            const modalGrid = document.getElementById('modal-schedule-grid');
            modalGrid.innerHTML = '';
            let modalGridHTML = `<div class="grid-header sticky-col">시간</div>`;
            days.forEach(day => { modalGridHTML += `<div class="day-header">${day}요일</div>`; });
            for (let h = startTimeHour; h < endTimeHour; h++) {
                ['00', '30'].forEach(m => {
                    modalGridHTML += `<div class="time-cell sticky-col">${String(h).padStart(2, '0')}:${m}</div>`;
                    days.forEach(day => {
                        modalGridHTML += `<div class="modal-schedule-cell" id="modal-cell-${day}-${h}-${m}"></div>`;
                    });
                });
            }
            modalGrid.innerHTML = modalGridHTML;
            days.forEach(day => {
                const subjects = scheduleData[day]?.[studentName] || [];
                subjects.forEach(subjectInfo => {
                    const duration = subjectInfo.end - subjectInfo.start;
                    for (let t = subjectInfo.start; t < subjectInfo.end; t += 30) {
                        const h = Math.floor(t / 60); const m = t % 60;
                        const cellM = m < 30 ? '00' : '30';
                        const cell = document.getElementById(`modal-cell-${day}-${h}-${cellM}`);
                        if (cell) {
                            let textContent = '';
                            if (t === subjectInfo.start) {
                                textContent = (duration <= 30) ? `<b>${subjectInfo.subject}</b><span class="memo-text">${subjectInfo.memo || ''}</span>` : `<b>${subjectInfo.subject}</b>`;
                            } else if (t === subjectInfo.start + 30) {
                                textContent = `<span class="memo-text">${subjectInfo.memo || ''}</span>`;
                            }
                            const block = document.createElement('div');
                            block.className = `subject-block ${subjectColors[subjectInfo.subject]}`;
                            block.innerHTML = textContent;
                            cell.appendChild(block);
                        }
                    }
                    styleStudentBlocks(studentName, day, true);
                });
            });
            document.getElementById('student-modal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('student-modal').style.display = 'none';
        }
        
        window.onload = () => {
            days.forEach(day => {
                db.collection('schedules').doc(day).onSnapshot((doc) => {
                    scheduleData[day] = doc.exists ? doc.data() : {};
                    renderDay(day);
                });
            });
            
            const modal = document.getElementById('student-modal');
            modal.onclick = function(event) { if (event.target == modal) { closeModal(); } }
        };
    </script>
</body>
</html>
